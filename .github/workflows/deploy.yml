name: Deploy to Alibaba Cloud ECS

on:
  push:
    branches: [main]
  workflow_dispatch:  # 支持手动触发

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          cd backend
          pip install -r requirements.txt

      - name: Run tests
        run: |
          cd backend
          pytest
        env:
          DATABASE_URL: ${{ secrets.TEST_DATABASE_URL }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}

  deploy:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Build frontend
        run: |
          cd frontend
          npm ci
          npm run build
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

      - name: Copy frontend to backend/static
        run: |
          rm -rf backend/static
          cp -r frontend/dist backend/static

      - name: Create .env.production
        run: |
          cat > backend/.env.production << EOF
          APP_NAME="LARP Admin API"
          APP_VERSION="0.1.0"
          DEBUG=false
          ENVIRONMENT=production
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          DATABASE_ECHO=false
          CORS_ORIGINS=${{ secrets.CORS_ORIGINS }}
          DEFAULT_PAGE_SIZE=20
          MAX_PAGE_SIZE=100
          VITE_SUPABASE_URL=${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY=${{ secrets.VITE_SUPABASE_ANON_KEY }}
          EOF

      - name: Deploy to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.ECS_HOST }}
          username: ${{ secrets.ECS_USERNAME }}
          key: ${{ secrets.ECS_SSH_KEY }}
          source: "."
          target: "/data/larpadmin"
          overwrite: true
          rm: true

      - name: Restart service
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.ECS_HOST }}
          username: ${{ secrets.ECS_USERNAME }}
          key: ${{ secrets.ECS_SSH_KEY }}
          script: systemctl restart larpadmin
