# 单人 AI 剧本杀「线索 & NPC 管理后台」PRD

先直接给你一份结构完整的 PRD，然后如果你后面需要我再拆成接口 / ERD / React 页面的级别，我们再迭代。

---

## 0. 项目概要

**产品名称**：单人 AI 剧本杀「线索 & NPC 管理后台」

**目标**：
- 让策划/编剧可以在可视化后台里维护线索与 NPC 设定，而不是手写 JSON。
- 通过树状结构展示线索层级 / 解锁关系，避免逻辑错乱。
- 支持多种线索匹配算法的配置、切换与对比实验，加速调优 LLM + 规则系统。

---

## 1. 产品背景 & 问题

### 当前问题（基于你之前的实现假设）

1. **线索数据、NPC 设定以 JSON 存在**：
   - 不好改，不好 review；
   - 线索解锁条件分散在 JSON 里，策划不直观。

2. **线索触发逻辑（关键词、embedding 相似度、混合策略等）**：
   - 目前算法可能是写死在代码里，难以调参；
   - 很难对比 "算法 A vs 算法 B" 在真实对话上的效果；
   - 策划希望"点一点"就切换当前使用的匹配策略。

3. **没有统一的"可视化线索树"**：
   - 不容易看出主线 / 支线 / 阶段锁；
   - 不容易检查死路、循环依赖。

因此需要一个面向内部运营/设计团队的管理后台。

---

## 2. 核心概念定义

为后面的字段和页面做统一术语：

- **剧本 (Script)**：一款完整案件或故事。
- **章节 / 场景 (Scene)**：剧本中的章节 / 地点 / 时间段。
- **NPC**：剧本中的可对话角色。
- **线索 (Clue)**：
  - 玩家可以获得的一条信息；
  - 对应一组触发条件（关键词、语义相似度等）；
  - 可能有前置线索 / 阶段锁 / 多个解锁路径。
- **线索树 (Clue Tree)**：
  - 一个剧本下所有线索的层级结构 & 前后依赖关系列表/tree。
- **线索匹配算法 (Clue Matching Algorithm)**：
  - 对"玩家一句话 + 当前状态"输出"命中的线索列表"的策略；
  - 比如：
    - 纯关键词匹配；
    - Embedding + 余弦相似度；
    - 关键词规则 + Embedding 混合；
    - LLM 评分 / rerank 等。

---

## 3. 用户角色 & 使用场景

### 3.1 角色

1. **编剧 / 策划**
   - 维护剧本结构、线索内容 & 解锁逻辑；
   - 调整 NPC 人设、说话风格；
   - 在后台中快速「跑通」剧情路径。

2. **算法 / 工程**
   - 注册新的线索匹配算法实现；
   - 调参、做 offline/online 实验；
   - 看日志与分析报告。

3. **管理员 (Admin)**
   - 管理用户权限；
   - 冻结/恢复剧本版本；
   - 一键切换线上默认算法。

---

## 4. 核心需求（功能模块）

### 4.1 剧本 & 场景管理

**目的**：为线索 & NPC 提供归属结构。

**功能点**：

1. **剧本列表**
   - 展示：剧本名、状态（草稿/测试/线上）、版本号、创建人、更新时间。
   - 操作：新建 / 复制 / 归档 / 删除（软删）。

2. **剧本详情**
   - 基本信息：简介、人数设定（虽然是单人，但可用作文档）、预期时长、难度。
   - 场景管理：
     - 场景列表（排序可拖拽）；
     - 新增/编辑/删除场景（场景名、描述、对应 NPC 列表、场景类型：搜证/审问/自由对话等）。

---

### 4.2 NPC 设定管理

**目的**：可视化编辑 NPC 背景与与线索的关联，生成驱动 LLM 的 JSON 配置。

**功能点**：

1. **NPC 列表（按剧本/场景过滤）**
   - 显示：名字、角色定位（嫌疑人/证人/路人）、当前状态（在审讯/已消失）、绑定场景数。

2. **NPC 详情页**
   - **基本信息**：
     - 名字（中英可选）、年龄、职业、身份标签；
     - 人设摘要：性格、说话风格（口头禅、语气）、阵营/立场；
   - **剧情设定**：
     - 背景故事文本（可分段，支持 Markdown）；
     - 与其他 NPC 的关系（角色关系图中仅展示概要）；
   - **LLM Prompt 相关**：
     - system_prompt 模板（可预览 JSON 片段）；
     - 可插槽变量（如 {npc_id}, {scene}, {known_clues}）；
   - **关联线索**：
     - 表格列出该 NPC 可能提供/提及的线索；
     - 显示每条线索的解锁条件简述、当前是否启用。

---

### 4.3 线索管理（列表 + 详细编辑）

**目的**：把原来的 clues_xxx.json 显式化、可视化。

**功能点**：

1. **线索列表**
   - 可按：剧本 / 场景 / NPC / 阶段 / 标签过滤。
   - 显示字段：
     - 线索 ID；
     - 标题（内部用名）；
     - 对玩家展示的文本（前 30 字预览）；
     - 状态（启用/禁用/草稿）；
     - 线索类型（证据、证言、世界观信息、误导线索等）；
     - 所属阶段 / 章节；
     - 前置线索数量 & 直接子线索数量。

2. **线索详情编辑**
   - **基础信息**：
     - 线索 ID（自动生成）；
     - 内部标题 + 玩家可见标题；
     - 线索内容（可多种形式：文本、图片链接、结构化字段）；
     - 线索类型、重要度（关键/次要/彩蛋）；
     - 所属剧本 / 场景 / 关联 NPC（可多选 / 可空）；
     - 阶段：比如 阶段1：案发现场 / 阶段2：锁定嫌疑人。
   - **解锁条件（重点）**：
     - **文本条件**：
       - 关键词列表（含 AND/OR、must/should）；
       - 黑名单关键词（出现则不触发）；
     - **语义条件**：
       - 目标 query 文本集合（多条 paraphrase）；
       - 相似度阈值（0-1 浮点数）；
     - **状态条件**：
       - 前置线索（已获得某些线索）；
       - 玩家状态（当前场景、当前轮次、与 NPC 好感度等）；
       - 阶段锁（例如：必须在阶段 >= 2 且 < 4）；
     - **自定义条件脚本（预留）**：
       - 用于高级逻辑（可配置函数名 / 规则 ID，由后端实现）。
   - **触发效果**：
     - 对玩家展示的文案；
     - 更新的游戏状态（解锁新线索、推进章节、改变 NPC 好感度等）；
     - 是否一次性（触发后不可再次触发）。
   - **元数据**：
     - 创建人、创建时间、最后修改人 / 时间；
     - 版本号 & 版本历史（可回滚到某个版本）。

---

### 4.4 线索层级关系可视化（线索树视图）

**目的**：直观展示线索之间的 "解锁树"。

**功能点**：

1. **视图入口**
   - 每个剧本有一个「线索树」页面；
   - 支持按场景 / 阶段过滤，只渲染子树。

2. **展现形式**
   - 左右或上下树形 / DAG 结构：
     - 根节点可以是「起始状态」或若干主线线索；
     - 节点：线索（显示标题 + 类型 + 阶段）；
     - 边：解锁关系 / 依赖关系。
   - 基本交互：
     - 缩放、拖拽画布；
     - 节点点击进入线索详情；
     - 展开/收起子节点；
     - 高亮某条线索的所有路径（从根到此/从此到所有后代）。

3. **编辑能力**
   - 拖拽建立/修改前置线索：
     - 从 A 拖到 B 的上方，代表「A 是 B 的前置条件」；
     - UI 中弹出确认：增加前置关系时是否添加到线索的解锁条件中。
   - 批量操作：
     - 批量选中一串线索，统一设置阶段；
     - 检测循环依赖：如果出现环，提示并标红。

4. **质量检查（可选增量）**
   - 检测 "死线索"：永远无法满足前置条件；
   - 检测 "孤儿线索"：没有前置也不被任何节点引用；
   - 提示"多路径解锁"情况（用于复杂设计审查）。

---

### 4.5 线索匹配算法管理

**目的**：将 "算法实现" 与 "策略配置" 解耦，让后台可以切换/调参。

**概念拆分**：
- **算法实现 (Algorithm Implementation)**：后端代码层面的实现，约定 ID，如 keyword_v1, embedding_v2, hybrid_v1 等，由工程师注册。
- **算法配置 (Algorithm Config / Strategy)**：在后台可配置的参数组合（阈值、权重、filters 等），并可以指定默认使用哪个实现 + 参数。

**功能点**：

1. **算法实现列表（只读 / 工程师维护）**
   - 字段：
     - 算法实现 ID（如 keyword_v1）
     - 类型：keyword / embedding / hybrid / llm_rerank …
     - 说明文档链接（可选）
     - 状态（可用 / 下线）。

2. **算法策略配置列表（策划可操作）**
   - 字段：
     - 策略 ID（如 default_v1、aggressive_keyword）
     - 绑定算法实现 ID；
     - 参数 JSON（如 keyword 权重、embedding 阈值、max_clue_count 等）；
     - 作用范围：全局 / 指定剧本 / 指定场景 / 指定 NPC；
     - 当前是否为默认策略（全局默认 / 剧本默认）。

3. **策略编辑页**
   - 基础信息：名字、描述、适用场景（比如"更侧重主线线索，减少误触发"）。
   - 参数设置（根据不同实现类型动态渲染表单）：
     - **keyword 算法参数例子**：
       - 最低命中关键词个数；
       - 权重配置（强关键词/弱关键词）；
       - 是否忽略停用词；
     - **embedding 算法参数例子**：
       - 相似度阈值；
       - top-k 值；
       - 是否加入上下文窗口。
     - **hybrid 参数例子**：
       - keyword vs embedding 权重比例；
       - 两者均满足时才触发 / 任一满足即可。
   - 版本管理：
     - 策略可保存多个版本；
     - 区分：草稿 / 已发布；
     - 仅已发布版本可用于线上。

4. **默认策略选择**
   - 全局配置页：
     - 选择全游戏默认策略（例如 global_default = hybrid_v1）；
   - 剧本级覆盖：
     - 每个剧本可以选一个策略覆盖全局；
   - 场景 / NPC 细粒度覆盖（可选）：
     - 在特殊场景中使用对"误触发更宽容"的策略。

---

### 4.6 匹配效果评估 & 实验（A/B 测试思路）

**目的**：让你可以系统性对比不同算法策略的效果，而不是凭感觉。

**功能点**：

1. **真实对话日志回放**
   - 数据结构：
     - 玩家说话文本；
     - 当前上下文（场景、已解锁线索列表）；
     - 实际使用的算法策略；
     - 触发的线索列表；
     - 最终展示给玩家的线索 ID。
   - 后台查看：
     - 可按：剧本、时间范围、策略 ID 过滤；
     - 支持查看某次对话的完整序列（便于分析错误触发）。

2. **Offline 评估数据集**
   - 支持导入标注数据集：
     - 每条：玩家输入 + 理想线索集合；
     - 在后台选择一个或多个策略，对该数据集跑一遍结果：
       - 计算命中率、Precision、Recall、F1、平均触发线索数等。
     - 导出评估报告（表格+图表）。

3. **在线 A/B 测试（可后续迭代）**
   - 配置实验：
     - 实验 ID；
     - 对比策略：A / B / C ；
     - 流量分配比例（如 50/50、40/40/20）；
     - 实验范围（某个剧本 / 全游戏）；
     - 指标：
       - 玩家完成率 / 卡关率；
       - 玩家反馈（如果有评分机制）；
       - 对话轮数、平均线索触发数。

---

### 4.7 在线模拟 & 调试工具

**目的**：给策划和工程师一个"单步调试"界面。

**功能点**：

1. **对话模拟面板**
   - 选择：
     - 剧本 / 场景 / 当前 NPC；
     - 使用的算法策略；
     - 指定当前已解锁线索（可多选）；
     - 输入框：模拟"玩家说的话"。
   - 输出面板：
     - 显示各线索的匹配得分 / 命中原因：
       - 关键词匹配详情（命中了哪些词）；
       - embedding 相似度数值；
       - 最终过滤后展示给玩家的线索列表。
     - 一键"继续下一轮"：
       - 把刚才命中的线索加入"已解锁线索"，便于逐轮模拟。

2. **单线索调试**
   - 在某个线索详情页点击"调试"：
     - 输入测试用例（玩家话术）；
     - 看到该线索是否被触发、触发原因；
     - 调整阈值后快速重跑。

---

### 4.8 用户权限 & 审计

**目的**：避免误操作导致线上剧本崩坏。

**功能点**：

1. **角色类型**
   - Admin：所有权限；
   - Designer：编辑剧本/NPC/线索，但不能改全局算法/实验；
   - Algorithm：编辑算法策略、导入评估集、创建实验；
   - Viewer：只读。

2. **审计日志**
   - 记录：
     - 谁在什么时候改了哪个剧本/线索/算法策略；
     - 修改前后 diff 简要摘要（比如名称变化、条件变化）。
   - 可按对象/用户/时间筛选查看。

---

## 5. 信息架构 & 页面结构

左侧导航大致结构：

1. **剧本管理**
   - 剧本列表
   - 剧本详情（场景管理 + 线索树入口）

2. **NPC 管理**
   - NPC 列表
   - NPC 详情

3. **线索管理**
   - 线索列表
   - 线索详情
   - 线索树视图（也可从剧本详情进入）

4. **匹配算法**
   - 算法实现列表（只读）
   - 策略配置列表
   - 策略详情

5. **实验 & 评估**
   - 对话日志
   - Offline 评估
   - 实验配置（A/B 测试）

6. **调试工具**
   - 对话模拟
   - 单线索调试

7. **系统设置**
   - 全局默认策略
   - 用户 & 权限
   - 审计日志

---

## 6. 数据结构（字段草案）

只给关键实体的核心字段，便于你后面画 ERD/写 schema：

### 6.1 Clue（线索）

```typescript
id: string
script_id: string
scene_id: string | null
title_internal: string
title_player: string
content_text: string
content_type: enum("text", "image", "structured")
content_payload: jsonb  // 图片url、结构化内容等

clue_type: enum("evidence", "testimony", "world_info", "decoy", ...)
importance: enum("critical", "major", "minor", "easter_egg")
stage: integer           // 剧情阶段

npc_ids: string[]        // 关联 NPC

status: enum("draft", "active", "disabled")

unlock_conditions: jsonb // 结构化定义关键词、embedding、状态条件、前置线索
effects: jsonb           // 游戏状态变化

created_by: string
created_at: timestamp
updated_by: string
updated_at: timestamp
version: integer
```

### 6.2 NPC

```typescript
id: string
script_id: string
name: string
name_en: string | null
age: integer | null
job: string | null
role_type: enum("suspect", "witness", "other")
personality: text
speech_style: text
background_story: text
relations: jsonb        // 与其他 NPC 的关系概要
system_prompt_template: text
extra_prompt_vars: jsonb

status: enum("active", "archived")
created_by, created_at, updated_by, updated_at
```

### 6.3 Algorithm Strategy（策略）

```typescript
id: string
name: string
description: text
impl_id: string           // 算法实现 ID
scope_type: enum("global", "script", "scene", "npc")
scope_target_id: string | null
params: jsonb             // 不同实现的参数配置
status: enum("draft", "published", "deprecated")
is_default: boolean

created_by, created_at, updated_by, updated_at
```

---

## 7. 关键指标（用于评估产品是否成功）

- **策划角度**：
  - 同一剧本从"设想 → 可跑通"的时间（缩短多少）。
  - 线索逻辑错误数量（死路、冲突）是否下降。
- **算法角度**：
  - Offline 评估指标：F1, Precision, Recall。
  - 玩家平均卡关次数 / 请求求助次数。
  - A/B 实验中玩家完成率、平均游戏时长、满意度评分。

---

## 8. 非功能需求（简要）

- **技术栈建议**：
  - 前端：React + 组件库（Ant Design / MUI 等）+ 支持树图/流程图（如 React Flow、G6、X6）。
  - 后端：沿用你现有 LangChain/LangGraph + Python 服务；
  - 数据库：Postgres（方便 JSONB 存储复杂条件和参数）。
- **性能**：
  - 线索数量级：单剧本 100–1000 条线索；
  - 线索树页面需要虚拟滚动 / 局部渲染。
- **安全 & 版本控制**：
  - 所有影响线上游戏的修改需通过"发布"流程；
  - 支持回滚到某个版本（至少：剧本层级、策略层级的版本）。

---
