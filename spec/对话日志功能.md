# 对话日志功能

对话日志用于记录和查看玩家与 NPC 之间的对话历史，包括线索匹配过程和调试信息。

---

## 功能概览

| 功能 | 说明 |
|------|------|
| 日志列表 | 分页查询对话日志，支持按剧本、NPC、时间筛选 |
| 会话分组 | 按 session_id 将对话分组显示 |
| 详情查看 | 查看单条对话的详细信息 |
| 匹配过程 | 显示线索匹配的候选列表、策略、阈值 |
| 分色显示 | 不同颜色区分模板静态内容和变量替换内容 |

---

## 数据模型

### 后端 - DialogueLog Model

**文件**: `backend/app/models/log.py`

```python
class DialogueLog(Base):
    __tablename__ = "dialogue_logs"

    id: str                    # 日志 ID (dl_xxxxx)
    session_id: str            # 会话 ID (用于分组)
    username: str | None       # 用户名
    script_id: str             # 剧本 ID
    npc_id: str                # NPC ID
    player_message: str        # 玩家消息
    npc_response: str | None   # NPC 回复
    context: dict              # 上下文 (已解锁线索等)
    matched_clues: dict        # 匹配到的线索
    triggered_clues: list[str] # 触发的线索 ID 列表
    debug_info: dict           # 调试信息
    created_at: datetime       # 创建时间
```

### 前端 - DialogueLog Type

**文件**: `frontend/src/types/index.ts`

```typescript
interface DialogueLog {
  id: string;
  session_id: string;
  username?: string | null;
  script_id: string;
  npc_id: string;
  player_message: string;
  npc_response: string;
  context: DialogueLogContext;
  matched_clues: MatchedClue[];
  triggered_clues: string[];
  debug_info: DialogueLogDebugInfo;
  created_at: string;
}

interface DialogueLogContext {
  unlocked_clue_ids: string[];
  matching_strategy: string;
  template_id?: string | null;
  llm_config_id?: string | null;
  npc_clue_template_id?: string | null;
  npc_no_clue_template_id?: string | null;
  npc_chat_config_id?: string | null;
}

interface DialogueLogDebugInfo {
  total_clues?: number;
  total_candidates?: number;
  total_excluded?: number;
  total_matched?: number;
  total_triggered?: number;
  threshold?: number;
  strategy?: string;
  candidates?: CandidateClueDetail[];
  excluded?: string[];
  prompt_info?: PromptInfo | null;
}
```

---

## API 接口

### 后端 API

**文件**: `backend/app/api/logs.py`

#### 1. 列表查询

```
GET /logs
```

**参数**:
| 参数 | 类型 | 说明 |
|------|------|------|
| page | int | 页码 (默认 1) |
| page_size | int | 每页数量 (默认 20, 最大 100) |
| script_id | string | 按剧本 ID 筛选 |
| npc_id | string | 按 NPC ID 筛选 |
| start_date | datetime | 开始时间 |
| end_date | datetime | 结束时间 |

**响应**:
```json
{
  "items": [DialogueLog],
  "total": 100,
  "page": 1,
  "page_size": 20
}
```

### 前端 API

**文件**: `frontend/src/api/simulation.ts`

```typescript
const logApi = {
  // 分页列表
  list: (params: LogQueryParams) => Promise<PaginatedResponse<DialogueLog>>,

  // 获取单条日志
  get: (id: string) => Promise<DialogueLog>,

  // 获取会话下所有日志
  getSession: (sessionId: string) => Promise<DialogueLog[]>,
};
```

---

## 前端页面

**文件**: `frontend/src/pages/experiments/DialogueLogs.tsx`

### 1. 筛选区域

- 剧本选择器 (Select)
- NPC 选择器 (联动，根据剧本筛选)
- 时间范围选择器 (RangePicker)
- 会话分组开关 (Switch)

### 2. 列表展示

#### 扁平模式 (关闭分组)

| 列 | 说明 |
|------|------|
| session | 会话 ID (截断显示) |
| username | 用户名 |
| player_message | 玩家消息 |
| NPC | NPC 名称 |
| matched_clues | 匹配线索数量 |
| created_at | 时间 |
| actions | 查看详情按钮 |

#### 会话分组模式 (开启分组)

按 session_id 分组，展开后显示时间线形式的对话流：

```
Session: abc12345...
├─ 玩家: 你好
│  └─ NPC: 你好，有什么可以帮你的？
├─ 玩家: 昨晚发生了什么？
│  └─ NPC: 昨晚在书房听到了一些动静...
│     匹配线索: [书房线索] [声音线索]
└─ ...
```

### 3. 详情弹窗

Modal 包含三个 Tab：

#### Tab 1: 对话详情 (Dialogue)

- 会话 ID
- 时间
- NPC
- 玩家消息
- NPC 回复

#### Tab 2: 对话流 (Conversation)

ChatGPT 风格的对话展示：

1. **System Prompt** (可折叠)
2. **User Prompt** (可折叠)
3. **玩家消息** (蓝色气泡，右对齐)
4. **匹配过程** (可折叠)
   - 策略标签 (keyword/embedding/llm)
   - 阈值显示
   - 候选线索列表 (根据策略显示不同内容)
5. **NPC 回复** (白色气泡，左对齐)
6. **触发线索** (标签列表)

#### Tab 3: 配置上下文 (Context)

- 匹配策略
- 模板 ID (hover 显示详情)
- LLM 配置 ID (hover 显示详情)
- 已解锁线索列表
- 原始 JSON 数据

---

## 匹配过程显示

### 候选线索根据策略显示不同内容

#### keyword 策略

显示触发关键词标签：

```
血迹喷溅模式
[血迹] [血] [地板] [地上] [喷溅]
```

#### embedding 策略

显示渲染结果 (支持分色)：

```
血迹喷溅模式
渲染结果:
┌──────────────────────────────────────────┐
│[橙色]线索名称：[绿色]血迹喷溅模式          │
│[橙色]详情：[绿色]检查地板上的血迹...       │
└──────────────────────────────────────────┘
[□ 系统] [□ 模板] [□ 变量]
```

#### llm 策略

显示 LLM 匹配提示词 (支持分色)：

```
血迹喷溅模式
System Prompt:
┌──────────────────────────────────────────┐
│[蓝色]你是一个线索匹配助手。                │
│[橙色]请判断玩家消息是否涉及以下线索:       │
│[绿色]血迹喷溅模式                         │
└──────────────────────────────────────────┘
User Message:
┌──────────────────────────────────────────┐
│[橙色]玩家消息:                            │
│[绿色]我看到地上有很多血                    │
└──────────────────────────────────────────┘
[□ 系统] [□ 模板] [□ 变量]
```

### 分色显示颜色说明

| 类型 | 背景色 | 边框色 | 说明 |
|------|--------|--------|------|
| 系统 | `#e6f7ff` | `#91d5ff` | 系统自动添加的内容 |
| 模板 | `#fff7e6` | `#ffd591` | 模板定义的静态内容 |
| 变量 | `#f6ffed` | `#b7eb8f` | 变量替换的动态内容 |

---

## 组件结构

```
DialogueLogs.tsx
├── SegmentedPromptRenderer   # 分段提示词渲染 (分色)
├── PromptLegend              # 颜色图例
├── IdWithName                # ID 显示 (hover 详情)
├── SessionGroup              # 会话分组类型
├── flatColumns               # 扁平列表列定义
├── groupedColumns            # 分组列表列定义
├── renderSessionDetail       # 会话详情渲染 (时间线)
├── renderDialogueTab         # Tab 1: 对话详情
├── renderConversationTab     # Tab 2: 对话流
└── renderContextTab          # Tab 3: 配置上下文
```

---

## 相关文件清单

### 后端

| 文件 | 说明 |
|------|------|
| `app/models/log.py` | DialogueLog 数据模型 |
| `app/schemas/log.py` | 请求/响应 Schema |
| `app/api/logs.py` | API 路由 |

### 前端

| 文件 | 说明 |
|------|------|
| `src/pages/experiments/DialogueLogs.tsx` | 页面组件 |
| `src/api/simulation.ts` | API 调用 (logApi) |
| `src/types/index.ts` | 类型定义 |
| `src/locales/zh.json` | 中文翻译 |
| `src/locales/en.json` | 英文翻译 |

---

## 国际化 Key

```json
{
  "logs": {
    "title": "对话日志",
    "session": "会话",
    "sessionId": "会话 ID",
    "username": "用户名",
    "playerMessage": "玩家消息",
    "npcResponse": "NPC 回复",
    "matchedClues": "匹配线索",
    "triggeredClues": "触发线索",
    "time": "时间",
    "messageCount": "消息数",
    "clues": "条",
    "player": "玩家",
    "retrievalProcess": "匹配过程",
    "threshold": "阈值",
    "candidateClues": "候选线索",
    "matchDetails": "匹配详情",
    "systemPromptLabel": "System Prompt",
    "userPromptLabel": "User Prompt",
    "renderedContent": "渲染结果",
    "dialogueTab": "对话详情",
    "conversationTab": "对话流",
    "contextTab": "配置上下文"
  }
}
```
