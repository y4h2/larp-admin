# å¯¹è¯æ—¥å¿—åŠŸèƒ½

å¯¹è¯æ—¥å¿—ç”¨äºè®°å½•å’ŒæŸ¥çœ‹ç©å®¶ä¸ NPC ä¹‹é—´çš„å¯¹è¯å†å²ï¼ŒåŒ…æ‹¬çº¿ç´¢åŒ¹é…è¿‡ç¨‹å’Œè°ƒè¯•ä¿¡æ¯ã€‚

---

## åŠŸèƒ½æ¦‚è§ˆ

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| æ—¥å¿—åˆ—è¡¨ | åˆ†é¡µæŸ¥è¯¢å¯¹è¯æ—¥å¿—ï¼Œæ”¯æŒæŒ‰å‰§æœ¬ã€NPCã€æ—¶é—´ç­›é€‰ |
| ä¼šè¯åˆ†ç»„ | æŒ‰ session_id å°†å¯¹è¯åˆ†ç»„æ˜¾ç¤º |
| è¯¦æƒ…æŸ¥çœ‹ | æŸ¥çœ‹å•æ¡å¯¹è¯çš„è¯¦ç»†ä¿¡æ¯ |
| åŒ¹é…è¿‡ç¨‹ | æ˜¾ç¤ºçº¿ç´¢åŒ¹é…çš„å€™é€‰åˆ—è¡¨ã€ç­–ç•¥ã€é˜ˆå€¼ |
| åˆ†è‰²æ˜¾ç¤º | ä¸åŒé¢œè‰²åŒºåˆ†æ¨¡æ¿é™æ€å†…å®¹å’Œå˜é‡æ›¿æ¢å†…å®¹ |
| LLM ç»Ÿè®¡ | Token ç”¨é‡å’Œè°ƒç”¨å»¶è¿Ÿæ˜¾ç¤º |

---

## æ•°æ®æ¨¡å‹

### åç«¯ - DialogueLog Model

**æ–‡ä»¶**: `backend/app/models/log.py`

```python
class DialogueLog(Base):
    __tablename__ = "dialogue_logs"

    id: str                    # æ—¥å¿— ID (dl_xxxxx)
    session_id: str            # ä¼šè¯ ID (ç”¨äºåˆ†ç»„)
    username: str | None       # ç”¨æˆ·å
    script_id: str             # å‰§æœ¬ ID
    npc_id: str                # NPC ID
    player_message: str        # ç©å®¶æ¶ˆæ¯
    npc_response: str | None   # NPC å›å¤
    context: dict              # ä¸Šä¸‹æ–‡ (å·²è§£é”çº¿ç´¢ç­‰)
    matched_clues: dict        # åŒ¹é…åˆ°çš„çº¿ç´¢
    triggered_clues: list[str] # è§¦å‘çš„çº¿ç´¢ ID åˆ—è¡¨
    debug_info: dict           # è°ƒè¯•ä¿¡æ¯ (åŒ…å« llm_usage)
    created_at: datetime       # åˆ›å»ºæ—¶é—´
```

### å‰ç«¯ - DialogueLog Type

**æ–‡ä»¶**: `frontend/src/types/index.ts`

```typescript
interface DialogueLog {
  id: string;
  session_id: string;
  username?: string | null;
  script_id: string;
  npc_id: string;
  player_message: string;
  npc_response: string;
  context: DialogueLogContext;
  matched_clues: MatchedClue[];
  triggered_clues: string[];
  debug_info: DialogueLogDebugInfo;
  created_at: string;
}

interface DialogueLogContext {
  unlocked_clue_ids: string[];
  matching_strategy: string;
  template_id?: string | null;
  llm_config_id?: string | null;
  npc_clue_template_id?: string | null;
  npc_no_clue_template_id?: string | null;
  npc_chat_config_id?: string | null;
}

interface DialogueLogDebugInfo {
  total_clues?: number;
  total_candidates?: number;
  total_excluded?: number;
  total_matched?: number;
  total_triggered?: number;
  threshold?: number;
  strategy?: string;
  candidates?: CandidateClueDetail[];
  excluded?: ExcludedClueDetail[];
  prompt_info?: PromptInfo | null;
  llm_usage?: LLMUsageInfo;  // Token ç”¨é‡å’Œå»¶è¿Ÿ
}

interface LLMUsageInfo {
  matching_tokens?: LLMTokenUsage;
  matching_latency_ms?: number;
  matching_model?: string;
  npc_tokens?: LLMTokenUsage;
  npc_latency_ms?: number;
  npc_model?: string;
}

interface LLMTokenUsage {
  prompt_tokens?: number;
  completion_tokens?: number;
  total_tokens?: number;
}
```

---

## API æ¥å£

### åç«¯ API

**æ–‡ä»¶**: `backend/app/api/logs.py`

#### 1. åˆ—è¡¨æŸ¥è¯¢

```
GET /logs
```

**å‚æ•°**:
| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| page | int | é¡µç  (é»˜è®¤ 1) |
| page_size | int | æ¯é¡µæ•°é‡ (é»˜è®¤ 20, æœ€å¤§ 100) |
| script_id | string | æŒ‰å‰§æœ¬ ID ç­›é€‰ |
| npc_id | string | æŒ‰ NPC ID ç­›é€‰ |
| start_date | datetime | å¼€å§‹æ—¶é—´ |
| end_date | datetime | ç»“æŸæ—¶é—´ |

**å“åº”**:
```json
{
  "items": [DialogueLog],
  "total": 100,
  "page": 1,
  "page_size": 20
}
```

### å‰ç«¯ API

**æ–‡ä»¶**: `frontend/src/api/simulation.ts`

```typescript
const logApi = {
  // åˆ†é¡µåˆ—è¡¨
  list: (params: LogQueryParams) => Promise<PaginatedResponse<DialogueLog>>,

  // è·å–å•æ¡æ—¥å¿—
  get: (id: string) => Promise<DialogueLog>,

  // è·å–ä¼šè¯ä¸‹æ‰€æœ‰æ—¥å¿—
  getSession: (sessionId: string) => Promise<DialogueLog[]>,
};
```

---

## å‰ç«¯é¡µé¢

**æ–‡ä»¶**: `frontend/src/pages/experiments/DialogueLogs/`

### 1. ç­›é€‰åŒºåŸŸ

- å‰§æœ¬é€‰æ‹©å™¨ (Select)
- NPC é€‰æ‹©å™¨ (è”åŠ¨ï¼Œæ ¹æ®å‰§æœ¬ç­›é€‰)
- æ—¶é—´èŒƒå›´é€‰æ‹©å™¨ (RangePicker)
- ä¼šè¯åˆ†ç»„å¼€å…³ (Switch)

### 2. åˆ—è¡¨å±•ç¤º

#### æ‰å¹³æ¨¡å¼ (å…³é—­åˆ†ç»„)

| åˆ— | è¯´æ˜ |
|------|------|
| session | ä¼šè¯ ID (æˆªæ–­æ˜¾ç¤º) |
| username | ç”¨æˆ·å |
| player_message | ç©å®¶æ¶ˆæ¯ |
| NPC | NPC åç§° |
| matched_clues | åŒ¹é…çº¿ç´¢æ•°é‡ |
| created_at | æ—¶é—´ |
| actions | æŸ¥çœ‹è¯¦æƒ…æŒ‰é’® |

#### ä¼šè¯åˆ†ç»„æ¨¡å¼ (å¼€å¯åˆ†ç»„)

æŒ‰ session_id åˆ†ç»„ï¼Œå±•å¼€åæ˜¾ç¤ºæ—¶é—´çº¿å½¢å¼çš„å¯¹è¯æµï¼š

```
Session: abc12345...
â”œâ”€ ç©å®¶: ä½ å¥½
â”‚  â””â”€ NPC: ä½ å¥½ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ çš„ï¼Ÿ
â”œâ”€ ç©å®¶: æ˜¨æ™šå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ
â”‚  â””â”€ NPC: æ˜¨æ™šåœ¨ä¹¦æˆ¿å¬åˆ°äº†ä¸€äº›åŠ¨é™...
â”‚     åŒ¹é…çº¿ç´¢: [ä¹¦æˆ¿çº¿ç´¢] [å£°éŸ³çº¿ç´¢]
â””â”€ ...
```

### 3. è¯¦æƒ…å¼¹çª— (LogDetailModal)

Modal åŒ…å«ä¸¤ä¸ª Tabï¼š

---

## Tab 1: å¯¹è¯æµ (ConversationTab)

**æ–‡ä»¶**: `components/LogDetailModal/ConversationTab.tsx`

### 1.1 ä¼šè¯å…ƒæ•°æ®

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¼šè¯ ID: abc12345...  |  2024-01-15 14:30  |  NPC: ç®¡å®¶    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 LLM ä½¿ç”¨ç»Ÿè®¡é¢æ¿ (LLMUsagePanel)

æ˜¾ç¤º Token ç”¨é‡å’Œè°ƒç”¨å»¶è¿Ÿï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âš¡ LLM ç”¨é‡                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚ â”‚ [åŒ¹é…] (gpt-4o)      â”‚  â”‚ [ç”Ÿæˆ] (gpt-4o)      â”‚          â”‚
â”‚ â”‚ â± å»¶è¿Ÿ: 850ms       â”‚  â”‚ â± å»¶è¿Ÿ: 1.2s        â”‚          â”‚
â”‚ â”‚ ğŸ“Š Tokens: 1,234    â”‚  â”‚ ğŸ“Š Tokens: 2,567    â”‚          â”‚
â”‚ â”‚ è¾“å…¥: 1,000 | è¾“å‡º: 234 â”‚  â”‚ è¾“å…¥: 2,000 | è¾“å‡º: 567 â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è¯´æ˜**:
- åŒ¹é… (ç´«è‰²æ ‡ç­¾): LLM çº¿ç´¢åŒ¹é…çš„ Token/å»¶è¿Ÿ
- ç”Ÿæˆ (ç»¿è‰²æ ‡ç­¾): NPC å›å¤ç”Ÿæˆçš„ Token/å»¶è¿Ÿ
- æ˜¾ç¤ºæ¨¡å‹åç§° (å¦‚ gpt-4o)
- æ— æ•°æ®æ—¶è‡ªåŠ¨éšè—

### 1.3 æ£€ç´¢è¿‡ç¨‹ (Retrieval Process)

å¯æŠ˜å åŒºåŸŸï¼Œæ˜¾ç¤ºçº¿ç´¢åŒ¹é…è¯¦æƒ…ï¼š

#### LLM ç­–ç•¥æ—¶çš„æç¤ºè¯æ˜¾ç¤º

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ” æ£€ç´¢è¿‡ç¨‹  [llm]  é˜ˆå€¼: 0.5                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ System Prompt:                                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ [è“è‰²]ä½ æ˜¯ä¸€ä¸ªçº¿ç´¢åŒ¹é…åŠ©æ‰‹ã€‚                              â”‚ â”‚
â”‚ â”‚ [æ©™è‰²]è¯·åˆ¤æ–­ç©å®¶æ¶ˆæ¯æ˜¯å¦æ¶‰åŠä»¥ä¸‹çº¿ç´¢:                     â”‚ â”‚
â”‚ â”‚ [ç»¿è‰²]è¡€è¿¹å–·æº…æ¨¡å¼                                       â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ User Message:                                               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ [æ©™è‰²]ç©å®¶æ¶ˆæ¯:                                          â”‚ â”‚
â”‚ â”‚ [ç»¿è‰²]æˆ‘çœ‹åˆ°åœ°ä¸Šæœ‰å¾ˆå¤šè¡€                                  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ [â–¡ ç³»ç»Ÿ] [â–¡ æ¨¡æ¿] [â–¡ å˜é‡]                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å€™é€‰çº¿ç´¢å¾—åˆ†å±•ç¤º (CandidateScoreDisplay)

æ˜¾ç¤ºæ‰€æœ‰å€™é€‰çº¿ç´¢çš„å¾—åˆ†å¯¹æ¯”ï¼Œé¢œè‰²åŒºåˆ†çŠ¶æ€ï¼š

```
å€™é€‰çº¿ç´¢ (5)                              é˜ˆå€¼: 50%
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ… å·²è§¦å‘  âš ï¸ å·²åŒ¹é…  âŒ æœªåŒ¹é…
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… è¡€è¿¹å–·æº…æ¨¡å¼         85% â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ [å·²è§¦å‘]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âš ï¸  å¨å£«å¿Œé…’æ¯           62% â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âŒ é—å˜±è‰ç¨¿             35% â–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âŒ å›­ä¸çš„è§‚å¯Ÿ           28% â–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ”’ æ’é™¤çº¿ç´¢ (1)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸš« ç®¡å®¶çš„è¯è¯           [å‰ç½®æœªè§£é”]             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é¢œè‰²è¯´æ˜**:
| çŠ¶æ€ | å›¾æ ‡ | èƒŒæ™¯è‰² | è¯´æ˜ |
|------|------|--------|------|
| å·²è§¦å‘ | âœ… | ç»¿è‰² `#f6ffed` | score >= threshold ä¸”å·²è§¦å‘ |
| å·²åŒ¹é… | âš ï¸ | é»„è‰² `#fffbe6` | score >= threshold ä½†æœªè§¦å‘ |
| æœªåŒ¹é… | âŒ | ç™½è‰² | score < threshold |
| å·²æ’é™¤ | ğŸš« | ç°è‰²è™šçº¿ | å‰ç½®æ¡ä»¶ä¸æ»¡è¶³ |

#### åŒ¹é…è¯¦æƒ… (Match Details)

å¯æŠ˜å ï¼Œæ˜¾ç¤ºåŒ¹é…åŸå› æ ‡ç­¾ï¼š

```
è¡€è¿¹å–·æº…æ¨¡å¼: [keyword: è¡€è¿¹] [keyword: å–·æº…] [LLM: 85%]
```

### 1.4 NPC å›å¤åŒºåŸŸ (NPC Reply Section)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ¤– NPC å›å¤åŒºåŸŸ  [æœ‰çº¿ç´¢æ¨¡æ¿]                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ System Prompt:                                              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ [åˆ†è‰²æ¸²æŸ“çš„ç³»ç»Ÿæç¤ºè¯]                                    â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                             â”‚
â”‚ ğŸ’¬ èŠå¤©å†å² (3 è½®)  [å¯æŠ˜å ]                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ç©å®¶: ä½ å¥½                                               â”‚ â”‚
â”‚ â”‚ NPC: ä½ å¥½ï¼Œè¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„ï¼Ÿ                       â”‚ â”‚
â”‚ â”‚ ...                                                      â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                             â”‚
â”‚ User Prompt:                                                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ [åˆ†è‰²æ¸²æŸ“çš„ç”¨æˆ·æç¤ºè¯]                                    â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                             â”‚
â”‚ NPC å›å¤:                                                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ æˆ‘æ³¨æ„åˆ°åœ°æ¿ä¸Šæœ‰ä¸€äº›å¥‡æ€ªçš„ç—•è¿¹...                         â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Tab 2: è°ƒè¯•è¯¦æƒ… (DebugTab)

**æ–‡ä»¶**: `components/LogDetailModal/DebugTab.tsx`

### 2.1 ç®—æ³•æµç¨‹ç»Ÿè®¡

å¯è§†åŒ–æ˜¾ç¤ºåŒ¹é…æµç¨‹ä¸­çš„æ•°é‡å˜åŒ–ï¼š

```
ğŸ“Š ç®—æ³•æµç¨‹
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ€»çº¿ç´¢  â”‚ â†’ â”‚ å€™é€‰    â”‚ â†’ â”‚ åŒ¹é…    â”‚ â†’ â”‚ è§¦å‘    â”‚
â”‚   15   â”‚    â”‚   8    â”‚    â”‚   3    â”‚    â”‚   2    â”‚
â”‚  è“è‰²  â”‚    â”‚  ç´«è‰²  â”‚    â”‚  æ©™è‰²  â”‚    â”‚  ç»¿è‰²  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
                                          â”‚ æ’é™¤    â”‚
                                          â”‚   2    â”‚
                                          â”‚  çº¢è‰²  â”‚
                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ•°å€¼è¯´æ˜**:
| æŒ‡æ ‡ | é¢œè‰² | è¯´æ˜ |
|------|------|------|
| æ€»çº¿ç´¢ | è“è‰² `#1890ff` | NPC å¯è§¦å‘çš„çº¿ç´¢æ€»æ•° |
| å€™é€‰ | ç´«è‰² `#722ed1` | è¿›å…¥åŒ¹é…æµç¨‹çš„çº¿ç´¢æ•° |
| åŒ¹é… | æ©™è‰² `#fa8c16` | å¾—åˆ†è¶…è¿‡é˜ˆå€¼çš„çº¿ç´¢æ•° |
| è§¦å‘ | ç»¿è‰² `#52c41a` | æœ€ç»ˆè§¦å‘çš„çº¿ç´¢æ•° |
| æ’é™¤ | çº¢è‰² `#ff4d4f` | å› å‰ç½®æ¡ä»¶æ’é™¤çš„çº¿ç´¢æ•° |

### 2.2 åŒ¹é…é…ç½®

è¡¨æ ¼å½¢å¼æ˜¾ç¤ºæœ¬æ¬¡åŒ¹é…ä½¿ç”¨çš„é…ç½®ï¼š

```
âš™ï¸ åŒ¹é…é…ç½®
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åŒ¹é…ç­–ç•¥          â”‚ [llm]                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ é˜ˆå€¼              â”‚ [50%]                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åŒ¹é…æ¨¡æ¿ ID       â”‚ tpl_xxx... (hover æ˜¾ç¤ºåç§°)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ LLM é…ç½® ID       â”‚ llm_xxx... (hover æ˜¾ç¤ºåç§°)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æœ‰çº¿ç´¢å›å¤æ¨¡æ¿    â”‚ tpl_yyy... (hover æ˜¾ç¤ºåç§°)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ— çº¿ç´¢å›å¤æ¨¡æ¿    â”‚ tpl_zzz... (hover æ˜¾ç¤ºåç§°)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 å·²è§£é”çº¿ç´¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å·²è§£é”çº¿ç´¢                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [clue_001] [clue_002] [clue_003] [clue_004]             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## åˆ†è‰²æ˜¾ç¤ºé¢œè‰²è¯´æ˜

| ç±»å‹ | èƒŒæ™¯è‰² | è¾¹æ¡†è‰² | è¯´æ˜ |
|------|--------|--------|------|
| ç³»ç»Ÿ | `#e6f7ff` | `#91d5ff` | ç³»ç»Ÿè‡ªåŠ¨æ·»åŠ çš„å†…å®¹ |
| æ¨¡æ¿ | `#fff7e6` | `#ffd591` | æ¨¡æ¿å®šä¹‰çš„é™æ€å†…å®¹ |
| å˜é‡ | `#f6ffed` | `#b7eb8f` | å˜é‡æ›¿æ¢çš„åŠ¨æ€å†…å®¹ |

---

## ç»„ä»¶ç»“æ„

```
DialogueLogs/
â”œâ”€â”€ index.tsx                     # ä¸»é¡µé¢ (åˆ—è¡¨ã€ç­›é€‰)
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ LogDetailModal/
â”‚   â”‚   â”œâ”€â”€ index.tsx             # Modal å®¹å™¨ (2 ä¸ª Tab)
â”‚   â”‚   â”œâ”€â”€ ConversationTab.tsx   # Tab 1: å¯¹è¯æµ
â”‚   â”‚   â””â”€â”€ DebugTab.tsx          # Tab 2: è°ƒè¯•è¯¦æƒ…
â”‚   â”œâ”€â”€ SegmentedPromptRenderer.tsx  # åˆ†æ®µæç¤ºè¯æ¸²æŸ“ (åˆ†è‰²)
â”‚   â”œâ”€â”€ PromptLegend.tsx          # é¢œè‰²å›¾ä¾‹
â”‚   â””â”€â”€ IdWithName.tsx            # ID æ˜¾ç¤º (hover è¯¦æƒ…)
â””â”€â”€ ...
```

### ConversationTab å†…éƒ¨ç»„ä»¶

| ç»„ä»¶ | è¯´æ˜ |
|------|------|
| LLMUsagePanel | LLM Token/å»¶è¿Ÿç»Ÿè®¡é¢æ¿ |
| CandidateScoreDisplay | å€™é€‰çº¿ç´¢å¾—åˆ†å¯è§†åŒ– |

---

## ç›¸å…³æ–‡ä»¶æ¸…å•

### åç«¯

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `app/models/log.py` | DialogueLog æ•°æ®æ¨¡å‹ |
| `app/schemas/log.py` | è¯·æ±‚/å“åº” Schema |
| `app/schemas/simulate.py` | SimulateResponse (å« LLMUsageInfo) |
| `app/api/logs.py` | API è·¯ç”± |
| `app/api/simulate.py` | æ¨¡æ‹Ÿ API (ä¿å­˜æ—¥å¿—é€»è¾‘) |

### å‰ç«¯

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `src/pages/experiments/DialogueLogs/` | é¡µé¢ç›®å½• |
| `src/pages/experiments/DialogueLogs/index.tsx` | ä¸»é¡µé¢ |
| `src/pages/experiments/DialogueLogs/components/` | ç»„ä»¶ç›®å½• |
| `src/api/simulation.ts` | API è°ƒç”¨ (logApi) |
| `src/types/index.ts` | ç±»å‹å®šä¹‰ |
| `src/locales/zh.json` | ä¸­æ–‡ç¿»è¯‘ |
| `src/locales/en.json` | è‹±æ–‡ç¿»è¯‘ |

---

## å›½é™…åŒ– Key

```json
{
  "logs": {
    "title": "å¯¹è¯æ—¥å¿—",
    "session": "ä¼šè¯",
    "sessionId": "ä¼šè¯ ID",
    "username": "ç”¨æˆ·å",
    "playerMessage": "ç©å®¶æ¶ˆæ¯",
    "npcResponse": "NPC å›å¤",
    "matchedClues": "åŒ¹é…çº¿ç´¢",
    "triggeredClues": "è§¦å‘çº¿ç´¢",
    "time": "æ—¶é—´",
    "messageCount": "æ¶ˆæ¯æ•°",
    "clues": "æ¡",
    "player": "ç©å®¶",
    "retrievalProcess": "æ£€ç´¢è¿‡ç¨‹",
    "threshold": "é˜ˆå€¼",
    "candidateClues": "å€™é€‰çº¿ç´¢",
    "matchDetails": "åŒ¹é…è¯¦æƒ…",
    "systemPromptLabel": "System Prompt",
    "userPromptLabel": "User Prompt",
    "renderedContent": "æ¸²æŸ“ç»“æœ",
    "conversationFlow": "å¯¹è¯æµ",
    "debugDetails": "è°ƒè¯•è¯¦æƒ…",
    "algorithmFlow": "ç®—æ³•æµç¨‹",
    "matchConfig": "åŒ¹é…é…ç½®",
    "matchingStrategy": "åŒ¹é…ç­–ç•¥",
    "templateId": "åŒ¹é…æ¨¡æ¿",
    "llmConfigId": "LLM é…ç½®",
    "npcClueTemplate": "æœ‰çº¿ç´¢å›å¤æ¨¡æ¿",
    "npcNoClueTemplate": "æ— çº¿ç´¢å›å¤æ¨¡æ¿",
    "unlockedClues": "å·²è§£é”çº¿ç´¢",
    "noUnlockedClues": "æ— å·²è§£é”çº¿ç´¢",
    "noDebugInfo": "æ— è°ƒè¯•ä¿¡æ¯",
    "totalClues": "æ€»çº¿ç´¢",
    "candidates": "å€™é€‰",
    "matchedCount": "åŒ¹é…",
    "triggeredCount": "è§¦å‘",
    "excludedCount": "æ’é™¤",
    "excludedClues": "æ’é™¤çº¿ç´¢",
    "missingPrereqs": "å‰ç½®æœªè§£é”",
    "triggered": "å·²è§¦å‘",
    "noCluesMatched": "æœªåŒ¹é…",
    "npcReplySection": "NPC å›å¤åŒºåŸŸ",
    "hasClueTemplate": "æœ‰çº¿ç´¢æ¨¡æ¿",
    "noClueTemplate": "æ— çº¿ç´¢æ¨¡æ¿",
    "chatHistory": "èŠå¤©å†å²",
    "rounds": "è½®",
    "llmUsage": "LLM ç”¨é‡",
    "matching": "åŒ¹é…",
    "generation": "ç”Ÿæˆ",
    "latency": "å»¶è¿Ÿ",
    "tokens": "Tokens",
    "promptTokens": "è¾“å…¥",
    "completionTokens": "è¾“å‡º"
  }
}
```
