# 对话模拟 & 调试工具（补充：模板配置与变量绑定）

下面我直接在原 PRD 的基础上，补充「对话模拟面板的模板功能」的需求，你可以直接并进之前的 PRD。

---

## 4.7.1 背景

在对话模拟中，目前只支持：
- 选择剧本 / 场景 / NPC / 策略
- 手动输入"玩家说的话"
- 查看线索匹配结果 & 算法细节

但在真实系统中，你会用到一整套 Prompt 模板来驱动 LLM / LangGraph 节点（如 NPC 的 system prompt、对话格式、线索列表注入方式等），而不是简单的 system_prompt + user_input。

因此，需要在"对话模拟面板"中：
1. 支持配置/选择 Prompt 模板（语法类似 LangChain / Python f-string：{var}）。
2. 模板中的变量可以从当前 NPC、线索、剧本、场景以及玩家输入等字段中选择绑定。
3. 支持在面板中实时预览"模板渲染结果"，以便调试 Prompt。

---

## 4.7.2 模板语法设计

### 语法原则

- 使用类似 LangChain / Python f-string 的花括号占位符：{var_name}。
- 支持简单路径访问（点号）：
  - npc.name、npc.personality
  - clue.title_player
  - scene.description
  - script.title
- 支持特殊变量：
  - {player_input}：当前对话轮玩家输入
  - {unlocked_clues}：已解锁线索的列表（渲染策略见下）
  - {candidate_clues}：本次匹配出的候选线索列表
- 不执行任意代码，仅做安全的字符串替换和简单列表展开。

### 列表变量渲染规则（后台统一约定）示例

- {unlocked_clues} → 默认按如下格式拼接：

```
[1] 线索标题A - 概要...
[2] 线索标题B - 概要...
```

- 可在模板中使用更细粒度变量：
  - {unlocked_clues_titles}：只输出标题列表
  - 或在配置中指定列表渲染方式（例如 "一行一个" 或 "JSON"）。

详细渲染规则可以由后端实现时再细化，这里 PRD 给出指导思想。

---

## 4.7.3 对话模拟面板中的模板区域

在现有"对话模拟"页面基础上，新增一块「模板配置」区域。

### 1）模板选择 & 管理

- 在对话模拟面板顶部增加模板下拉框：
  - **模板类型（可多种）**：
    - NPC 对话模板（主）
    - 系统提示模板（可选）
    - 线索解释模板（可选，用于调试 LLM 如何向玩家说明线索）
  - **模板来源**：
    - 全局模板：所有剧本可见；
    - 剧本模板：只针对当前剧本；
    - NPC 专用模板：与某个 NPC 绑定。
  - **操作**：
    - 选择已有模板；
    - "新建模板"按钮（弹出模板编辑对话框）；
    - "另存为"复制模板。

### 2）模板编辑区域

- 编辑器支持：
  - 文本编辑区域（支持多行）；
  - 显示当前模板语法提示（说明 {var} 规则）；
  - 提供简单的高亮/校验（例如检查是否存在未绑定变量）。
- 示例模板（给策划参考）：

```
You are {npc.name}, a {npc.role_type}.
Personality: {npc.personality}
Background: {npc.background_story}

Current scene: {scene.name}
Known clues:
{unlocked_clues}

Player says: {player_input}

Based on your knowledge and personality, respond in first person Chinese.
```

---

## 4.7.4 变量选择面板（字段选择）

为满足"变量允许在 NPC 和线索的字段中选择"的需求，在模板编辑区域右侧增加变量选择栏。

### 1）变量来源分类

变量选择栏按来源分组展示：

1. **全局上下文变量**
   - player_input（玩家当前输入）
   - script.* （剧本字段）
   - scene.* （场景字段）
   - now（当前时间，可选）

2. **当前 NPC 变量**
   - npc.id
   - npc.name
   - npc.role_type
   - npc.personality
   - npc.speech_style
   - npc.background_story
   - npc.relations
   - npc.system_prompt_template（如需）

3. **线索变量**
   - 单条线索（用于"候选线索解释模板"等场景）：
    - clue.id
    - clue.title_internal
    - clue.title_player
    - clue.content_text
    - clue.clue_type
    - clue.importance
    - clue.stage
   - 列表变量：
    - unlocked_clues（已解锁线索列表）
    - candidate_clues（本轮命中的候选线索列表）

4. **算法 / 策略变量（可选）**
   - strategy.id
   - strategy.name
   - 方便在 prompt 中注入"这是一个 debug 模式"等信息。

### 2）插入变量交互

- 用户在模板编辑器中点击光标定位；
- 在右侧变量树中点击某个变量，例如：
  - 当前 NPC → name
  - 系统自动在光标处插入对应路径占位符：
    - {npc.name}
- 对于列表变量（如 unlocked_clues），则插入：
  - {unlocked_clues} 或者 {unlocked_clues_titles}（可以通过二级选项选择具体格式）

**目标**：让策划不需要记住完整路径，只要点选就能插入正确的占位符。

---

## 4.7.5 模板渲染预览

在对话模拟中，新增「渲染预览」区块，实时展示系统最终会发送给 LLM 的文本（或请求体的关键部分）。

### 1）渲染时机

每次变更下列变量之一时，重新渲染并展示结果：
- 当前选择的剧本 / 场景 / NPC；
- 模板内容；
- 变量绑定；
- 玩家输入；
- 已解锁线索列表 / 候选线索列表（当算法跑完后）。

### 2）展示内容

- 分 tab 显示不同部分：
  - SYSTEM PROMPT（如果有系统模板）
  - USER PROMPT（包含 {player_input} 渲染后的完整内容）
  - （可选）FULL REQUEST（结构化 JSON 的关键字段）
- 支持复制按钮复制完整 Prompt，方便直接粘贴到别的工具调试。

---

## 4.7.6 模板数据结构（新增实体）

为了在系统层面管理这些模板，可以新增一个实体 PromptTemplate：

```typescript
id: string
name: string                    // 模板名称
type: enum("system", "npc_dialog", "clue_explain", ...)
scope_type: enum("global", "script", "npc")
scope_target_id: string | null  // 比如 script_id / npc_id

content: text                   // 模板原文，含 {var} 占位符
variables_meta: jsonb           // 可选，用于存储已用变量列表，用于校验/提示

status: enum("draft", "active", "archived")

created_by, created_at, updated_by, updated_at
```

在对话模拟面板中：
- 通过 scope_type + scope_target_id 过滤出可用模板；
- 用户选中某个模板后，前端加载 content 到编辑器；
- 渲染时，后端接收：
  - template_id 或直接文本；
  - context 对象（包含 script / scene / npc / clues / player_input）；
  - 使用统一模板引擎进行替换输出。

---

## 4.7.7 校验 & 容错

- **当模板中存在无法解析的变量（例如 {npc.foobar} 字段不存在）时**：
  - 渲染预览区域提示警告：指出具体占位符；
  - 系统可选择：
    - 使用空字符串替代；
    - 或者提示"渲染失败，禁止发送"——用于严格模式。
- **当列表变量过长（例如 unlocked_clues 超过 50 个）**：
  - 在模板引擎层可限制最大长度，避免 prompt 过大；
  - 或者提示策划考虑添加筛选/截断逻辑（后端可默认取前 N 条）。

---

## 总结

这样，你的对话模拟面板就从"只是测算法匹配线索"，升级为：
- 可真实模拟「当前 NPC + 当前线索状态 + 当前策略 + Prompt 模板」下，完整 LLM 调用的行为；
- 策划可以像写 LangChain Prompt 一样，配置和迭代模板；
- 使用右侧变量选择，直接从 NPC / 线索字段中选择变量，减少出错。

如果你愿意，下一步我可以帮你：
- 设计 PromptTemplate 的 CRUD 页面（列表 + 详情 + 关联 NPC 的 UI）；
- 或者直接给一份 React 实现草稿：模板编辑器 + 右侧变量树 + 渲染预览组件的组件结构。

---
